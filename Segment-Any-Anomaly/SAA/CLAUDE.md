# CLAUDE.md

本文件旨在为代码智能体（如 Claude Code）提供在本仓库协作时的背景信息与注意事项。

## 项目概述

Segment-Any-Anomaly (SAA) 是一个基于 Python 的零样本异常检测项目，主要面向工业质检场景。系统将多种基础视觉模型与提示工程结合，通过语言、属性、显著性与置信度提示实现更稳健的异常定位与评分。

## 核心技术栈

1. **PyTorch** - 主要深度学习框架。
2. **Grounding DINO** - 提供文本引导的目标检测与候选框生成。
3. **Segment Anything Model (SAM)** - 对候选框进行像素级分割与细化。
4. **ImageNet 预训练模型** - 提供显著性计算所需的特征表示。
5. **OpenCV** - 用于图像读写、颜色空间转换与插值等处理。
6. **TIMM** - 提供可复用的骨干网络与辅助工具。

## 关键组件

### 主模型 (model.py)
核心 `Model` 类搭建了多阶段流水线：
- **文本引导掩码提案**：基于 Grounding DINO 的语言提示生成候选框。
- **区域细化**：借助 SAM 将候选框转为高质量掩码。
- **显著性计算**：调用 ImageNet 特征对掩码进行相似度/异常度评估。
- **置信度评分**：整合多种提示信息输出最终异常热图。

### 四类提示
- **语言提示 (P^L)**：描述可能的缺陷类型或外观。
- **属性提示 (P^P)**：限制对象数量、面积等全局属性。
- **显著性提示 (P^S)**：利用视觉相似度加强异常与背景的区分。
- **置信度提示 (P^C)**：对多个掩码进行加权融合与排序。

## 架构流程

1. **对象检测**：Grounding DINO + 文本提示生成候选区域。
2. **区域细化**：SAM 对候选框进行像素级分割。
3. **显著性评估**：ImageNet 特征网络输出的自相似度图用于重打分。
4. **异常评分**：综合四类提示输出最终异常概率图。

## 主要特性

1. **零样本检测**：无需专门标注即可通过提示描述异常。
2. **多尺度特征**：充分利用 ImageNet 预训练骨干。
3. **提示集成**：语言、属性、显著性、置信度四位一体。
4. **属性感知过滤**：通过面积/数量限制提升定位准确度。
5. **视觉显著性融合**：增强与背景的对比效果。

## 开发注意事项

- 当前实现仅支持 `batch_size = 1`。
- 属性提示作用在检测框层面，而非整张图像。
- 版本中尚未实现 IoU 约束，后续若需要需自行扩展。
- 体系依赖预训练模型与提示策略的协同，修改任一组件都应同步评估整体效果。
