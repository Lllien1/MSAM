# 坑点

## huggingface

### 无法连接

#### ① 清理掉你之前可能设置过的代理

先确保环境干净：

```
unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy HF_ENDPOINT
```

------

#### ② 使用 AutoDL 的学术资源加速（官方推荐方式）

AutoDL 官方提供了一个脚本 `/etc/network_turbo`，专门给 GitHub / HuggingFace 做代理加速，你只要在终端里执行：[autodl.com+1](https://www.autodl.com/docs/network_turbo/?utm_source=chatgpt.com)

```
# 在容器里执行
source /etc/network_turbo

# 看看脚本有没有帮你写好代理环境变量
env | grep -i proxy
```

如果脚本存在且执行成功，你会看到类似：

```
HTTP_PROXY=...
HTTPS_PROXY=...
```

然后再测试一下 HuggingFace 是否通了：

```
curl -I https://huggingface.co -m 10
```

- 如果能看到 `HTTP/2 200` / `302` 之类的响应头 → 说明已经能出网了。
- 如果还是超时/无法连接 → 看下一步（HF 镜像）。

最后再跑你的代码：

```
python eval_SAA.py
```



## PyTorch和CUDA不匹配

[(71 封私信 / 80 条消息) 如何解决PyTorch版本和CUDA版本不匹配的关系 - 知乎](https://zhuanlan.zhihu.com/p/633473214)



## 分词器 bert-base-uncased

[(71 封私信 / 80 条消息) 以bert-base-uncased为例快速下载hugging face模型 - 知乎](https://zhuanlan.zhihu.com/p/690572963)

- 新的 `bert-base-uncased` 文件夹正是 tokenizer（分词器）/模型加载器所需要的，但 `GroundingDINO/groundingdino/config/GroundingDINO_SwinT_OGC.py` 的第 34 行现在指向的是：

  ```
  autodl-tmp/Segment-Any-Anomaly/bert-base-uncased
  ```

  因为这个路径既不是绝对路径，也不是以 `./` 开头的相对路径，Hugging Face 会尝试把它当作一个模型仓库 ID（如 `autodl-tmp/...`）来处理，从而导致失败。

- **解决方法是更新那一行，使用真实的文件系统路径**，例如：

  ```python
  text_encoder_type = "/root/autodl-tmp/Segment-Any-Anomaly/bert-base-uncased"
  ```

  或者，如果你是从项目根目录运行脚本，也可以使用：

  ```python
  text_encoder_type = "./bert-base-uncased"
  ```

  这样 `AutoTokenizer.from_pretrained()` 就会从本地读取模型文件，而不会尝试联网下载。

- 如果你希望完全离线运行，也可以设置环境变量：

  ```bash
  export TRANSFORMERS_OFFLINE=1 HF_DATASETS_OFFLINE=1
  ```

  

  但关键还是要把配置文件中的路径指向正确的本地目录。

------

**修改完路径后，重新运行 `python eval_SAA.py`**，应该就能顺利通过 tokenizer 加载阶段。

------

现在 Grounding DINO 已经指向了本地文件夹，但 `GroundingDINO/groundingdino/util/get_tokenlizer.py` 的第 21-26 行仍然假设每个 text encoder 都是硬编码的模型名（如 `bert-base-uncased`）。当你传入的是一个文件系统路径时，它会直接抛出 `ValueError`。

你需要更新这个辅助函数，使其能识别本地目录作为有效的预训练模型路径：

```python
# GroundingDINO/groundingdino/util/get_tokenlizer.py
from pathlib import Path
...

def get_pretrained_language_model(text_encoder_type):
    path = Path(text_encoder_type)
    if path.exists():  # 本地路径（如 /root/.../bert-base-uncased）
        return BertModel.from_pretrained(str(path))
    if text_encoder_type == "bert-base-uncased":
        return BertModel.from_pretrained(text_encoder_type)
    if text_encoder_type == "roberta-base":
        return RobertaModel.from_pretrained(text_encoder_type)
    raise ValueError(f"Unknown text_encoder_type {text_encoder_type}")
```

你也可以在 `get_tokenlizer()` 函数中应用相同的 `Path.exists()` 逻辑，以确保 tokenizer 和 encoder 的行为一致。

最后，如果你希望强制离线模式，可以设置：

```bash
export TRANSFORMERS_OFFLINE=1 HF_DATASETS_OFFLINE=1
```

完成这些修改后，再次运行 `python eval_SAA.py`，模型加载应该就能成功了，因为它现在能识别并使用你本地的 BERT 目录。





# 效果

| 类别       | i_ROC(%) | p_ROC(%) | i_AP(%) | p_AP(%) | i_F1(%) | p_F1(%) | PRO(%) |
| :--------- | :------- | :------- | :------ | :------ | :------ | :------ | :----- |
| bottle     | 79.29    | 68.99    | 92.13   | 32.81   | 88.72   | 39.29   | 0.00   |
| cable      | 54.99    | 69.05    | 71.89   | 19.91   | 76.03   | 32.27   | 0.00   |
| capsule    | 52.01    | 61.88    | 85.74   | 8.29    | 90.46   | 17.68   | 0.00   |
| carpet     | 94.78    | 70.42    | 97.71   | 39.98   | 94.19   | 56.71   | 0.00   |
| grid       | 80.45    | 63.88    | 93.63   | 12.43   | 84.44   | 18.14   | 0.00   |
| hazelnut   | 83.93    | 85.46    | 90.27   | 38.71   | 85.71   | 44.80   | 0.00   |
| metal_nut  | 28.93    | 59.98    | 73.97   | 13.29   | 89.42   | 36.20   | 0.00   |
| pill       | 41.38    | 93.34    | 84.07   | 52.23   | 91.56   | 45.82   | 0.00   |
| tile       | 96.28    | 81.61    | 98.68   | 61.69   | 94.41   | 64.83   | 0.00   |
| toothbrush | 20.56    | 64.14    | 56.62   | 2.22    | 83.33   | 8.18    | 0.00   |
| transistor | 30.96    | 64.87    | 32.73   | 6.71    | 57.14   | 19.57   | 0.00   |
| wood       | 98.86    | 81.83    | 99.67   | 60.31   | 98.31   | 67.17   | 0.00   |
| zipper     | 36.71    | 78.82    | 76.59   | 12.42   | 88.15   | 21.28   | 0.00   |

- **bottle：**反光处好像都会容易被定义为异常，缺陷但是无反光处难以识别
- **cable：**难以分出正常异常，几乎是个电缆都会被SAM进行最终的分割，考虑GroundingDINO分割问题
- capsule：基本上都能够分割识别正确，但是丝印部分基本上都会被识别为异常，不能区别正常异常丝印
- carpet：效果好，纹理颜色较重的都能识别出来，但是目标和背景等大，mask给了一整个图，同时分割区域不全，感觉很多Saliency的热点图效果很好，<font color='red'>**但是最终被SAM2再次细化了？待验证，感觉不是很好**</font>
- grid：观察Saliency的热点图感觉效果不是很好，挺多正常交叉部分都是黄色以上了。弯曲的钢网部分难以被识别为异常。图像中，**<font color='red'>块和块能不能建立相似度，以应对这种有几乎规律的图片，利用块之间的相似上下文</font>**