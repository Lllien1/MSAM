# 一、强制使用本地 BERT（完全离线）

1. 先把 BERT 下载到本地（你已完成，目录如下）

```
/root/autodl-tmp/FiLo/third_party/bert-base-uncased
# 里面应包含：config.json、tokenizer.json、tokenizer_config.json、vocab.txt、pytorch_model.bin
```

1. 设置环境变量（告诉 transformers 离线+本地路径）

```
export TRANSFORMERS_OFFLINE=1
export FILO_BERT_LOCAL=/root/autodl-tmp/FiLo/third_party/bert-base-uncased
# 可选：有网时用镜像更稳
export HF_ENDPOINT=https://hf-mirror.com
export HF_HUB_TIMEOUT=120
export HF_HUB_ENABLE_HF_TRANSFER=0
```

1. 修改 GroundingDINO 的加载逻辑（你已按我发的 patch 做好）
    `models/GroundingDINO/groundingdino/util/get_tokenlizer.py` 中：

- `get_tokenlizer(text_encoder_type)` 与
   `get_pretrained_language_model(text_encoder_type)`
   都会优先读取 `FILO_BERT_LOCAL`，只要 `TRANSFORMERS_OFFLINE=1` 在，就不会再访问网络。

1. 快速自测（你也验证成功过）

```
from groundingdino.util.get_tokenlizer import get_tokenlizer, get_pretrained_language_model
tok = get_tokenlizer("bert-base-uncased")
bert = get_pretrained_language_model("bert-base-uncased")
print(tok.vocab_size, hasattr(bert, "embeddings"))
```

能跑通就说明“本地 BERT 强制生效”。

# 二、CUDA / PyTorch 动态库冲突的终极修复（已解决）

你之前遇到的 `libcublas.so.11: undefined symbol cublasLtGetStatusString` 是因为系统里混了不兼容的 CUDA 12 与 cu11 动态库。最终的稳定做法是：

- 只保留 `pip` 安装的 cu11 动态库路径并放到 `LD_LIBRARY_PATH` 最前；
- 干掉 `/usr/local/cuda*、/usr/local/nvidia*` 等会“抢位”的路径；
   你已经按下面方式修复成功（复用即可）：

```bash
PY_SITE=$(python - <<'PY'
import site; print(site.getsitepackages()[0])
PY
)
export LD_LIB_PIP="$PY_SITE/nvidia/cublas/lib:$PY_SITE/nvidia/cudnn/lib:$PY_SITE/nvidia/cuda_runtime/lib:$PY_SITE/nvidia/cuda_nvrtc/lib"
CLEAN_LD=$(echo "${LD_LIBRARY_PATH:-}" | tr ':' '\n' | grep -v '^/usr/local/cuda' | grep -v '^/usr/local/nvidia' | paste -sd ':' -)
export LD_LIBRARY_PATH="$LD_LIB_PIP${CLEAN_LD:+:$CLEAN_LD}"
python - <<'PY'
import torch
print("torch:", torch.__version__, "cuda:", torch.version.cuda)
print("torch.cuda.is_available:", torch.cuda.is_available())
PY
```

出现 `torch: 1.13.1+cu117` 且 `is_available: True` 就 OK。

# 三、让 GroundingDINO 模块可被 import（避免 ModuleNotFoundError）

两种任选其一：

- 临时：`export PYTHONPATH="$FILO_ROOT/models/GroundingDINO:${PYTHONPATH:-}"`
- 持久：在你的 `test.sh` 里写死上面的 `PYTHONPATH`。

# 四、MVTec 数据根目录正确设置（这次的 404 根因）

`mvtec_supervised.py` 期望的目录结构是：

```
{root}/{class}/train|test/... 和 {root}/{class}/ground_truth/...
```

你的真实数据在：`FiLo/data/mvtec_anomaly_detection/...`
 所以要：

```
export DATA_ROOT="$FILO_ROOT/data/mvtec_anomaly_detection"
cp -f "$FILO_ROOT/data/meta.json" "$DATA_ROOT/meta.json"
```

然后运行时用 `--data_path "$DATA_ROOT"`。

# 五、一条命令跑全流程（可做成 test.sh）

```
export FILO_ROOT=~/autodl-tmp/FiLo
export PYTHONPATH="$FILO_ROOT/models/GroundingDINO:${PYTHONPATH:-}"

# 离线本地 BERT
export TRANSFORMERS_OFFLINE=1
export FILO_BERT_LOCAL="$FILO_ROOT/third_party/bert-base-uncased"
export HF_ENDPOINT=https://hf-mirror.com
export HF_HUB_TIMEOUT=120
export HF_HUB_ENABLE_HF_TRANSFER=0

# 仅使用 pip 的 cu11 动态库
PY_SITE=$(python - <<'PY'
import site; print(site.getsitepackages()[0])
PY
)
export LD_LIB_PIP="$PY_SITE/nvidia/cublas/lib:$PY_SITE/nvidia/cudnn/lib:$PY_SITE/nvidia/cuda_runtime/lib:$PY_SITE/nvidia/cuda_nvrtc/lib"
CLEAN_LD=$(echo "${LD_LIBRARY_PATH:-}" | tr ':' '\n' | grep -v '^/usr/local/cuda' | grep -v '^/usr/local/nvidia' | paste -sd ':' -)
export LD_LIBRARY_PATH="$LD_LIB_PIP${CLEAN_LD:+:$CLEAN_LD}"

# 数据根
export DATA_ROOT="$FILO_ROOT/data/mvtec_anomaly_detection"
cp -f "$FILO_ROOT/data/meta.json" "$DATA_ROOT/meta.json"

# 跑
python "$FILO_ROOT/test.py" \
  --dataset mvtec \
  --data_path "$DATA_ROOT" \
  --ckpt_path "$FILO_ROOT/ckpt/filo_train_on_mvtec.pth" \
  --grounded_checkpoint "$FILO_ROOT/ckpt/grounding_train_on_mvtec.pth" \
  --box_threshold 0.35 --text_threshold 0.35 --area_threshold 0.7 \
  --device cuda
```

# 六、可选优化

- 装 `ninja` 能让 C++/CUDA 扩展编译更快：`pip install ninja`
- 把上述环境变量写进 `test.sh`，以后只需 `bash test.sh`。
- 需要在线切换别的 tokenizer/模型时，把 `TRANSFORMERS_OFFLINE` 设为 `0` 并移除 `FILO_BERT_LOCAL`。

现在你的日志里已经显示完整评测并输出了漂亮的分数 ✅
 如果接下来要换 VISA 数据集、调阈值、或做可视化导出，我可以给你现成的命令和脚本模板。



# 总结

```shell
# === FiLo 一键环境（重启后 source 即可）===

# 1) 激活 conda 环境
source ~/autodl-tmp/conda/etc/profile.d/conda.sh 2>/dev/null || true
conda activate filo

# 2) 路径与工程根
export FILO_ROOT="$HOME/autodl-tmp/FiLo"
export DATA_ROOT="$FILO_ROOT/data/mvtec_anomaly_detection"   # MVTEC 根目录
export PYTHONPATH="$FILO_ROOT/models/GroundingDINO:${PYTHONPATH:-}"

# 3) HF/Transformers 离线与镜像
export TRANSFORMERS_OFFLINE=1
export HF_ENDPOINT="https://hf-mirror.com"
export HF_HUB_TIMEOUT=120
export HF_HUB_ENABLE_HF_TRANSFER=0
export FILO_BERT_LOCAL="$FILO_ROOT/third_party/bert-base-uncased"   # 本地BERT目录

# 4) 让 PyTorch 用“pip 安装的 CUDA 11.7 动态库”优先（避免和系统 cuda-12 混）
PY_SITE=$(python - <<'PY'
import site
print(site.getsitepackages()[0])
PY
)
export LD_LIBRARY_PATH="$PY_SITE/nvidia/cublas/lib:$PY_SITE/nvidia/cudnn/lib:$PY_SITE/nvidia/cuda_runtime/lib:$PY_SITE/nvidia/cuda_nvrtc/lib:/root/autodl-tmp/conda/envs/filo/lib64:/usr/lib/x86_64-linux-gnu:/usr/lib/i386-linux-gnu"

# 5) GroundingDINO 的 GPU 算力目标（按你机器显卡）
export TORCH_CUDA_ARCH_LIST="7.0;7.5;8.0;8.6;8.9"

# 6) 可视化输出目录
export VIZ_DIR="$FILO_ROOT/viz_out"
mkdir -p "$VIZ_DIR"

# 7) 方便的别名：跑 MVTEC 全量测试 + 可视化
alias filo_test='python "$FILO_ROOT/test.py" \
  --dataset mvtec \
  --data_path "$DATA_ROOT" \
  --ckpt_path "$FILO_ROOT/ckpt/filo_train_on_mvtec.pth" \
  --grounded_checkpoint "$FILO_ROOT/ckpt/grounding_train_on_mvtec.pth" \
  --box_threshold 0.25 --text_threshold 0.25 --area_threshold 0.7 \
  --device cuda \
  --viz_dir "$VIZ_DIR"'

```



# 为什么有框但 mask 很弱/没有

这不是 bug，是**两个模型输出语义不同**带来的“错位”：

- **GroundingDINO** 负责“**文本-图像**的**检测**/框**”，它只看文字提示（例如 *anomaly, damage…*）与图像区域的对齐程度；有时它能对“可能异常的区域”给出框，但这个区域未必在你训练的 FiLo **像素级分割**看来同样强。

- **FiLo** 的**像素级异常热力图**是另一条分支：
   你代码里把多尺度 `anomaly_maps` 做均值、再做高斯平滑，然后还做了一个“框内=1、框外×0.7”的重权重：

  ```
  anomaly_score_copy[:, :, y1:y2, x1:x2] = 1
  anomaly_score = torch.where(anomaly_score_copy == 1, anomaly_score, anomaly_score * 0.7)
  ```

  这段会把**框外**的热力图整体压低（×0.7），如果 FiLo 原本热度就不强，就更不显眼；而**框内**也不是直接抬到 1（你只是把掩码设为 1，用它去做条件选择，没有“抬高分值”），所以可视化上容易出现“有框但整体不热”。

### 可以怎么调：

- 减少/取消“框外×0.7”的抑制；或者只在**阈值化之后**用框引导。
- 对 `anomaly_maps` **先做归一化**（min-max 到 0~1），再叠图，保证动态范围。
- 试下更“锐利”的后处理（开闭运算、CRF），让细长缺陷更连贯。
- GroundingDINO 的 `box_threshold/text_threshold` 稍微上调一点，减少“语义相关但不是缺陷”的小框。
- 你也可以把**框内区域的热度抬到 `max(anomaly_score)`** 或者 `np.percentile(..., 95)`，只做**可视化**上的增强；不影响计算指标。

下面补丁里我给你两行可以开关的参数：`TAG_MAX_WIDTH_PX`（控制是否截断/折行）和 `DOWNWEIGHT_OUTSIDE_BOX`（控制“框外×0.7”的抑制），默认改得更温和。



# 各指标表示

所有“_px”都是**像素级（pixel-level）**指标，所有“_sp”是**样本级（sample-level）**指标。

- **auroc_px**：把每张图的异常热图当作像素得分，与像素级 GT mask 做 ROC，求 AUC。越大越好，1.0=完美区分。
- **f1_px**：对像素级热图扫阈值（或按 PR 曲线选最佳），取 precision/recall 的调和平均的最大值。越大越好。
- **ap_px**：像素级**平均精度**（PR 曲线下的面积）。越大越好。
- **aupro**：**Per-Region Overlap** 的 AUC。它会限制 FPR（默认 0.3），统计 GT 每个连通区域在不同阈值下被命中的比例，然后对满足 FPR<0.3 的部分做 AUC，更强调“查到完整缺陷”的能力。越大越好。
- **auroc_sp**：把每张图的一个异常分数（代码里取了“text_probs 异常类概率 + 像素热图最大值”的平均）与该图是否异常（0/1）做 ROC-AUC。越大越好。
- **f1_sp**：样本级 F1（在图像层面找一条阈值，把异常图分出来）。越大越好。
- **ap_sp**：样本级平均精度。越大越好。
   （以上计算与阈值/归一化/分数构造方式有关，分数构造不合理就会拖累 sp 指标。）

如：25-10-09 16:46:57.755 - INFO

FiLo使用MVTec训练MVTec测试

|  objects   | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------: | :------: | :---: | :---: | :---: | :------: | :---: | :---: |
| toothbrush |   99.6   | 78.1  | 83.5  | 52.1  |   100    |  100  |  100  |
|    grid    |   99.6   | 65.1  | 65.9  | 81.1  |   99.9   | 99.1  |  100  |
| transistor |   98.5   | 77.5  | 81.2  | 81.1  |   98.5   | 92.5  |  98   |
|   bottle   |   99.4   | 86.9  |  92   | 89.8  |   100    |  100  |  100  |
|    wood    |   99.5   | 82.7  | 89.2  | 91.5  |   100    |  100  |  100  |
|  hazelnut  |   99.8   | 88.4  | 92.6  | 77.9  |   100    |  100  |  100  |
|  leather   |   99.9   | 81.8  | 86.8  | 93.9  |   100    |  100  |  100  |
|   carpet   |   99.8   | 81.9  | 89.5  | 90.8  |   100    |  100  |  100  |
|  capsule   |   99.4   | 68.5  | 71.2  | 78.7  |   100    |  100  |  100  |
|    tile    |   99.7   | 90.6  | 95.5  | 96.4  |   100    |  100  |  100  |
|   screw    |   99.3   | 69.9  | 72.3  | 62.5  |   98.3   | 95.7  | 99.4  |
| metal nut  |   99.8   | 95.8  | 97.2  | 91.4  |   100    |  100  |  100  |
|   cable    |   98.9   | 78.5  |  84   | 78.8  |   99.6   | 98.4  | 99.8  |
|   zipper   |   99.4   | 77.3  | 84.9  | 84.4  |   99.9   | 99.6  |  100  |
|    pill    |   99.9   | 91.7  |  94   | 85.7  |    99    | 99.3  | 99.8  |
|    mean    |   99.5   |  81   | 85.3  | 82.4  |   99.7   |  99   | 99.8  |

FiLo使用MVTec训练Visa测试

|  objects   | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------: | -------- | ----- | ----- | ----- | -------- | ----- | ----- |
|   candle   | 98.7     | 45.5  | 38.1  | 89.4  | 88.6     | 82.7  | 91.3  |
|   cashew   | 93.4     | 27.3  | 22.7  | 88.3  | 88       | 84.9  | 94.8  |
| pipe fryum | 95.5     | 22.2  | 15.7  | 79.6  | 86.4     | 87.1  | 93.4  |
|  capsules  | 94.9     | 30.9  | 21.1  | 83.4  | 82       | 82.2  | 89.8  |
| chewinggum | 99.6     | 78.7  | 84.7  | 93.5  | 97.2     | 93.5  | 98.7  |
|   fryum    | 94.4     | 28.4  | 23    | 83.8  | 83.4     | 84.2  | 92.1  |
| macaroni1  | 99.3     | 29.5  | 21.5  | 94.3  | 86.7     | 78.5  | 89    |
| macaroni2  | 98.8     | 23.1  | 11    | 92.3  | 74.3     | 72.2  | 75    |
|    pcb3    | 89.1     | 17    | 7.5   | 69.1  | 61.5     | 67.1  | 63.2  |
|    pcb1    | 93.5     | 23    | 15    | 78.2  | 79.8     | 75.1  | 82    |
|    pcb2    | 92.2     | 29.7  | 20    | 80.7  | 82.9     | 77.3  | 83.1  |
|    pcb4    | 96       | 36    | 31.7  | 89.6  | 95.7     | 90.3  | 95.2  |
|    mean    | 95.5     | 32.6  | 26    | 85.2  | 83.9     | 81.3  | 87.3  |

Grouding-DINO使用MVTec训练Visa测试

|  objects   | auroc_sp | f1_sp | ap_sp |
| :--------: | :------: | :---: | :---: |
|   candle   |   72.7   | 31.5  | 27.1  |
|  capsules  |   43.6   |  25   | 14.6  |
|   cashew   |   13.3   | 28.6  |  13   |
| chewinggum |   94.3   | 88.2  | 88.2  |
|   fryum    |    70    | 40.8  | 32.6  |
| macaroni1  |   54.7   | 21.7  | 15.1  |
| macaroni2  |   52.7   | 17.8  | 12.6  |
|    pcb1    |   63.5   | 33.4  | 17.1  |
|    pcb2    |   74.3   |  32   | 21.8  |
|    pcb3    |   71.6   | 28.3  | 16.5  |
|    pcb4    |   82.6   | 37.1  | 27.5  |
| pipe_fryum |   86.4   | 77.7  | 79.1  |
|    mean    |   67.9   | 30.4  | 20.1  |



# 只使用Grouding_DINO

```sh
gdino_only.py使用的时候要使用build_meta_from_visa.py创建出来的meta.json

python "$FILO_ROOT/tools/gdino_only.py" \
  --dataset visa \
  --data_path "$FILO_ROOT/data/VisA_20220922" \
  --use_meta \
  --grounded_checkpoint "$FILO_ROOT/ckpt/grounding_train_on_mvtec.pth" \
  --groundingdino_config "$FILO_ROOT/models/GroundingDINO/groundingdino/config/GroundingDINO_SwinT_OGC.py" \
  --device cuda \
  --viz_dir "$FILO_ROOT/viz_gdino_visa"
```







| 类别           | 中文异常描述                                                 |
| -------------- | ------------------------------------------------------------ |
| **carpet**     | 局部褪色、纹理异常斑块、边缘散纱或纤维脱落、烧烫伤痕迹       |
| **grid**       | 格子歪斜、开裂、缝隙过大、变色、变形、缺失、格子间距不均、锈蚀、崩边 |
| **leather**    | 划痕、褪色、折痕、纹理不均、撕裂、发脆、接缝开裂、热损伤、发霉 |
| **tile**       | 崩边、表面不平、变色、泛白、翘曲、缺片、凹陷、高低差（lippage）、霉斑、破损 |
| **wood**       | 节疤、翘曲、顺向开裂、表面霉斑、水渍染色、腐朽、虫眼、粗糙斑块、节疤凸起 |
| **bottle**     | 大/小裂纹、大/小凹坑、泄漏、褪色、变形、无盖、冷凝水过多、异味 |
| **cable**      | 扭结、股线打结、接头脱落、过度拉伸、凹陷、腐蚀、沿缆烧焦、导体裸露 |
| **capsule**    | 形状不规则、颜色不正、皱皮、合缝不齐、壳内水珠、异物、过软/过硬 |
| **hazelnut**   | 霉斑、颜色异常、腐臭、虫蛀、潮湿、外壳畸形、过薄、杂质、手感异常 |
| **metal nut**  | 裂纹、螺纹乱扣、生锈、缺失、扭曲、变色、接触面磨损、纹理不一 |
| **pill**       | 形状不规则、掉粉、包衣不均、气泡、开裂、斑点                 |
| **screw**      | 表面生锈、弯曲、螺纹损伤、滑牙、头部变形、镀层脱落、槽宽不一、尺寸偏差 |
| **toothbrush** | 刷毛松动、分布不均、掉毛严重、刷毛染色、触感粗糙、刷头变形   |
| **transistor** | 烧毁、引脚脱落、腐蚀、外形异常、裂纹、机械损伤、表面粗糙     |
| **zipper**     | 齿牙弯曲、布带毛边、错位、拉动卡涩、齿牙锈蚀、拉头脱落、松动、翘曲 |

| 类别           | 中文异常描述                                                 |
| -------------- | ------------------------------------------------------------ |
| **candle**     | 蜡体裂纹、蜡油围绕芯线堆积、隧道效应、熔池不完整、火焰闪烁、额外溢蜡、蜡流出蜡烛 |
| **capsules**   | 胶囊大小不均、壳体发脆、过软、凹陷、内部水珠、合缝不齐、斑点 |
| **cashew**     | 颜色斑驳、霉斑、异物、口感异常、空壳、受潮、粘连             |
| **chewinggum** | 硬度异常、异物、颜色不均、过硬、同色污点                     |
| **fryum**      | 形状畸形、异味、色差、质感异常、细小划痕、异色点、粘连、其他 |
| **macaroni1**  | 形状不一、细小划痕、微裂、色差、虫蛀、纹理不均、口感异常     |
| **macaroni2**  | 畸形、划痕、异物、水分过高、虫害、微裂、质感异常             |
| **pcb1/2/3/4** | 铜箔氧化、分层、锡桥、焊渣过多、变色、焊点不平、板弯、过孔缺失 |
| **pipe fryum** | 形状不均、异物、异色点、异味、空心、质感异常、同色污点、粘连 |



mvtec训练 测试mvtec

| objects    | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------- | -------: | ----: | ----: | ----: | -------: | ----: | ----: |
| toothbrush |     99.6 |  78.1 |  83.5 |  52.3 |      100 |   100 |   100 |
| grid       |     99.6 |  65.5 |  67.1 |  81.1 |     99.9 |  99.1 |   100 |
| wood       |     99.6 |  83.2 |  89.2 |  91.4 |      100 |   100 |   100 |
| bottle     |     99.4 |  87.3 |  92.6 |  89.8 |      100 |   100 |   100 |
| transistor |     98.5 |  77.4 |  83.9 |  81.8 |     98.9 |  93.7 |  98.5 |
| hazelnut   |     99.8 |  88.7 |  92.1 |  76.8 |      100 |   100 |   100 |
| carpet     |     99.8 |  81.8 |    86 |  90.4 |      100 |   100 |   100 |
| leather    |     99.9 |  82.1 |  85.2 |  93.7 |      100 |   100 |   100 |
| capsule    |     99.4 |  68.2 |  70.6 |  78.1 |      100 |   100 |   100 |
| tile       |     99.8 |  91.1 |    97 |    97 |      100 |   100 |   100 |
| screw      |     99.3 |    70 |  71.7 |  61.2 |     98.4 |  95.7 |  99.5 |
| metal nut  |     99.8 |  95.8 |  98.1 |  90.6 |      100 |   100 |   100 |
| cable      |     98.9 |  78.8 |  85.4 |  78.8 |     99.6 |  98.4 |  99.8 |
| zipper     |     99.4 |  76.8 |  83.8 |  84.1 |     99.9 |  99.6 |   100 |
| pill       |     99.9 |  91.8 |  95.3 |  85.5 |       99 |  99.3 |  99.8 |
| mean       |     99.5 |  81.1 |  85.4 |  82.2 |     99.7 |    99 |  99.8 |

mvtec训练 零样本VisA

| objects    | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------- | -------: | ----: | ----: | ----: | -------: | ----: | ----: |
| cashew     |     95.2 |  48.1 |  41.6 |  85.5 |     87.9 |  84.9 |  94.8 |
| pipe fryum |     97.1 |  42.1 |  34.1 |  88.3 |     86.5 |  87.4 |  93.4 |
| chewinggum |     99.5 |  74.1 |  81.6 |  93.7 |     97.3 |  93.9 |  98.8 |
| capsules   |     95.3 |  39.3 |  27.4 |  80.7 |     81.1 |  80.8 |  89.2 |
| fryum      |     94.9 |  32.2 |  25.8 |  83.7 |     83.6 |  83.7 |  92.2 |
| macaroni2  |     98.7 |    24 |  12.6 |  92.5 |     72.6 |  70.9 |  73.8 |
| macaroni1  |     99.3 |  29.5 |  23.6 |  92.7 |     86.9 |  79.1 |  89.1 |
| pcb1       |     94.2 |  34.3 |    24 |  77.4 |     80.6 |  75.4 |  83.1 |
| candle     |     98.8 |  44.9 |  35.8 |  88.5 |     87.4 |  82.1 |  90.4 |
| pcb2       |     92.1 |  30.2 |  20.5 |  80.3 |     83.3 |  77.1 |  83.6 |
| pcb3       |     89.3 |  22.2 |  13.9 |  69.4 |     67.2 |  67.8 |  69.3 |
| pcb4       |     96.2 |  37.9 |  31.5 |  90.4 |       95 |  90.1 |  94.4 |
| mean       |     95.9 |  38.2 |    31 |  85.3 |     84.1 |  81.1 |  87.7 |

VisA训练 VisA验证
| objects    | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------- | -------: | ----: | ----: | ----: | -------: | ----: | ----: |
| cashew     |     99.8 |  93.8 |  97.4 |  45.9 |     93.8 |  90.9 |  97.4 |
| pipe fryum |     99.9 |  88.3 |  94.9 |  41.7 |     99.5 |    98 |  99.8 |
| chewinggum |     99.8 |  84.4 |  90.5 |  48.2 |     99.9 |    99 |   100 |
| fryum      |     99.1 |  84.2 |  90.7 |  21.9 |     92.8 |  91.4 |    97 |
| capsules   |     99.8 |  77.5 |  75.4 |  62.7 |     95.5 |  94.8 |  97.9 |
| macaroni1  |     97.6 |  46.6 |  35.2 |  23.1 |       86 |  87.2 |  91.7 |
| pcb3       |     91.1 |  61.4 |  56.4 |  29.2 |     94.4 |  93.8 |  96.5 |
| macaroni2  |     95.1 |  26.8 |  15.7 |  16.3 |     86.9 |  80.2 |  88.9 |
| pcb2       |     96.3 |    52 |  43.6 |  34.8 |     96.9 |  93.2 |  97.6 |
| candle     |     98.7 |    59 |  59.9 |  40.4 |     88.2 |  82.8 |  91.7 |
| pcb1       |     98.6 |  82.6 |  86.7 |    39 |     96.6 |  94.8 |  97.7 |
| pcb4       |     98.8 |  61.8 |  62.6 |  62.2 |     99.2 |  96.4 |  99.3 |
| mean       |     97.9 |  68.2 |  67.4 |  38.8 |     94.2 |  91.9 |  96.3 |

Visa训练 Mvtec验证
| objects    | auroc_px | f1_px | ap_px | aupro | auroc_sp | f1_sp | ap_sp |
| :--------- | -------: | ----: | ----: | ----: | -------: | ----: | ----: |
| toothbrush |     96.6 |  46.4 |  44.2 |  84.8 |     91.4 |  95.1 |  95.8 |
| grid       |     97.2 |  42.4 |  39.9 |  50.3 |     98.8 |  98.2 |  99.6 |
| wood       |       98 |  64.4 |  68.2 |  57.6 |     98.2 |  96.7 |  99.4 |
| bottle     |     94.9 |  62.2 |  66.9 |  82.6 |     96.3 |  95.4 |  98.8 |
| transistor |     69.4 |  23.8 |  16.1 |    39 |     78.9 |    75 |  79.2 |
| hazelnut   |     98.4 |  62.7 |  67.9 |  69.4 |     92.8 |  92.9 |  95.9 |
| carpet     |     99.5 |  73.8 |    81 |  68.2 |     99.8 |  98.9 |   100 |
| leather    |     99.6 |    57 |    58 |  83.1 |      100 |   100 |   100 |
| capsule    |     89.6 |  37.2 |  33.5 |  52.9 |     88.8 |    91 |  97.7 |
| tile       |     95.5 |  74.1 |  80.1 |  70.6 |     97.2 |  96.4 |  99.1 |
| screw      |     98.6 |  38.4 |    31 |  52.8 |     71.4 |  86.1 |  87.2 |
| metal nut  |     98.7 |  88.1 |    93 |  80.5 |     99.3 |  97.9 |  99.8 |
| zipper     |     95.2 |    39 |  40.1 |  27.9 |     89.2 |  90.1 |  97.2 |
| cable      |     87.3 |  28.6 |  26.1 |  48.2 |     87.2 |    84 |  93.5 |
| pill       |     75.7 |  36.9 |  32.2 |  50.3 |     82.8 |  92.4 |  96.5 |
| mean       |     92.9 |  51.7 |  51.9 |  61.2 |     91.5 |  92.7 |    96 |
