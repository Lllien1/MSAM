```bash
(sowa) root@autodl-container-94c54eab15-1fc7e5e2:~/autodl-tmp/sowa/src# python eval.py 
In 'eval.yaml': Could not find 'model/anomaly_clip'

Available options in 'model':
        sowa_hfwa
        sowa_linear
        sparc_hfwa
        sparc_linear
        sparc_prompt
Config search path:
        provider=hydra, path=pkg://hydra.conf
        provider=main, path=file:///root/autodl-tmp/sowa/configs
        provider=hydra-colorlog, path=pkg://hydra_plugins.hydra_colorlog.conf
        provider=schema, path=structured://

Set the environment variable HYDRA_FULL_ERROR=1 for a complete stack trace.
(sowa) root@autodl-container-94c54eab15-1fc7e5e2:~/autodl-tmp/sowa/src# 
```



## 默认地址修改

- 代码默认通过 configs/paths/default.yaml (lines 1-12) 里的 root_dir: ${oc.env:PROJECT_ROOT} 与 data_dir: ${paths.root_dir}/data/ 来推导路径。要使用 /root/autodl-tmp/sowa 作为工程根目录，最简单的方式是先导出环境变量：export PROJECT_ROOT=/root/autodl-tmp/sowa；如果不方便设置环境变量，也可以把同一文件里的 root_dir 改成 . 并把 data_dir 直接写成 /root/autodl-tmp/data。
- 数据配置（例如 configs/data/sowa_mvt.yaml (lines 2-23)、configs/data/sowa_visa.yaml 等）目前写死在 /home/hzx/Projects/Data/...。请把 data_dir.train/valid/test 这些字段改成你真实的数据子目录，比如 /root/autodl-tmp/data/Visa、/root/autodl-tmp/data/MVTec-AD。这样 AnomalyCLIPDataModule 才会从新路径加载图像。
- 运行时也可以通过 Hydra 覆盖而不改文件：python src/train.py paths.root_dir=/root/autodl-tmp/sowa paths.data_dir=/root/autodl-tmp/data data.sowa_mvt.data_dir.train=/root/autodl-tmp/data/Visa ...。不过如果永久迁移，直接修改上述 YAML 更省心。
- 其它文件（如 src/train.py, src/eval.py, scripts/*.sh）只引用 paths.* 与 data.*，一旦 configs/paths/default.yaml 和具体数据配置指向新目录，就不需要额外改动。



## 为 VisA 生成 `meta.json`

你的 `VisASolver` 会从 `root/split_csv/1cls.csv` 读取划分，并写出 `root/meta.json`。字段包括 `img_path / mask_path / cls_name / specie_name / anomaly`，并分 `train/test` 两个 phase（脚本里就是这么组织的）。visa

> 请先确认有这个 CSV：`/root/autodl-tmp/data/VisA_20220922/split_csv/1cls.csv`
>  若没有，你需要准备或自己导出这个 CSV（脚本依赖它来确定划分与掩码路径）。

**一键生成**（不改文件，直接用类调用覆盖 `root`）：

```
python - <<'PY'
from visa import VisASolver
runner = VisASolver(root='/root/autodl-tmp/data/VisA_20220922')
runner.run()
print("Wrote:", runner.meta_path)
PY
```

完成后应出现：`/root/autodl-tmp/data/VisA_20220922/meta.json`（就是你的代码在报错里要找的那个）。

------

##  为 MVTec 生成 `meta.json`

`MVTecSolver` 会**直接遍历目录结构**（不需要 CSV），把每个类别 `train/test` 下的 `good/defect` 子类与 `ground_truth` 掩码配对，写出 `root/meta.json`。mvtec

**一键生成：**

```
python - <<'PY'
from mvtec import MVTecSolver
runner = MVTecSolver(root='/root/autodl-tmp/data/mvtec_anomaly_detection')
runner.run()
print("Wrote:", runner.meta_path)
PY
```

完成后会生成：`/root/autodl-tmp/data/mvtec_anomaly_detection/meta.json`。

------

## 再次运行评估（GPU + AMP + 离线 W&B + 可视化保存）

你的 `eval.yaml` 里：train 用 MVTec，valid/test 用 VisA（你之前贴的配置就是这么写的）。生成好两个 `meta.json` 后直接跑：

```
export WANDB_MODE=offline
export WANDB_SILENT=true

python eval.py \
  trainer.accelerator=gpu trainer.devices=1 '+trainer.precision="16-mixed"' \
  data.batch_size=8 data.num_workers=4 \
  logger.wandb.offline=true logger.wandb.log_model=false \
  callbacks.visualization.visualize=true \
  callbacks.visualization.dirpath=/root/autodl-tmp/sowa/logs/eval/visualizations
```

> 若你用 4090 想更稳一点，也可以把 `"16-mixed"` 换成 `"bf16-mixed"`。
>  评估完成后，可视化在：`/root/autodl-tmp/sowa/logs/eval/visualizations/`



# 效果

对异常类的检测效果十分好，少样本性能几乎达到专家模型的效果
